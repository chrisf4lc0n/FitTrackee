# FitTrackee Sink Folder Auto-Import Stack
#
# This is a complete standalone stack for running FitTrackee with the sink folder
# auto-import feature. It includes the database, main app, and sink watcher.
#
# Usage:
#   1. Copy .env.example to .env and configure
#   2. docker compose up -d
#   3. Create user folders: mkdir -p ./data/uploads/sink/{username}
#   4. Drop workout files into the folder
#
# For existing FitTrackee installations, you can also just add the fittrackee-sink
# service to your existing docker-compose.yml

services:
  fittrackee-db:
    container_name: fittrackee-db
    image: postgis/postgis:17-3.5-alpine
    env_file:
      - .env
    volumes:
      - ${HOST_DATABASE_DIR:-./data/db}:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $${POSTGRES_USER} -d $${POSTGRES_DB}"]
      interval: 5s
      timeout: 15s
      retries: 3
    networks:
      - internal_network
    restart: unless-stopped

  fittrackee:
    container_name: fittrackee
    env_file:
      - .env
    # Use pre-built image or build locally
    image: fittrackee/fittrackee:v1.0.3
    # build:
    #   context: ..
    #   dockerfile: Dockerfile
    volumes:
      - ${HOST_UPLOAD_DIR:-./data/uploads}:/usr/src/app/uploads
      - ${HOST_LOG_DIR:-./data/logs}:/usr/src/app/logs
      - ${HOST_STATICMAP_CACHE_DIR:-./data/staticmap_cache}:/usr/src/app/.staticmap_cache
    post_start:
      - command: chown -R fittrackee:fittrackee /usr/src/app/uploads /usr/src/app/logs /usr/src/app/.staticmap_cache
        user: root
    ports:
      - "${HOST_APP_PORT:-5000}:5000"
    command: 'sh docker-entrypoint.sh'
    depends_on:
      fittrackee-db:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget --spider http://127.0.0.1:5000/api/ping || exit 1"]
      interval: 5s
      timeout: 15s
      retries: 3
    networks:
      - external_network
      - internal_network
    restart: unless-stopped

  fittrackee-sink:
    container_name: fittrackee-sink
    env_file:
      - .env
    # Use pre-built image or build locally
    image: fittrackee/fittrackee:v1.0.3
    # build:
    #   context: ..
    #   dockerfile: docker-sink/Dockerfile
    environment:
      - PROCESS_EXISTING=true
    volumes:
      - ${HOST_UPLOAD_DIR:-./data/uploads}:/usr/src/app/uploads
      - ${HOST_LOG_DIR:-./data/logs}:/usr/src/app/logs
      - ${HOST_STATICMAP_CACHE_DIR:-./data/staticmap_cache}:/usr/src/app/.staticmap_cache
    post_start:
      - command: chown -R fittrackee:fittrackee /usr/src/app/uploads /usr/src/app/logs /usr/src/app/.staticmap_cache
        user: root
    command: "ftcli workouts sink_watch --process-existing -v"
    depends_on:
      fittrackee:
        condition: service_healthy
    networks:
      - internal_network
    restart: unless-stopped

networks:
  external_network:
  internal_network:
    internal: true
